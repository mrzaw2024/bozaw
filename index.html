<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lottery Analysis Tool</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f0f0f0; 
      padding: 10px; 
      max-width: 1200px;
      margin: 0 auto;
    }
    .box { 
      background: white; 
      border-left: 5px solid red; 
      padding: 15px; 
      margin-bottom: 15px; 
      border-radius: 6px; 
    }
    .title { 
      font-weight: bold; 
      margin-bottom: 10px; 
      font-size: 18px; 
    }
    input[type="text"], input[type="number"] {
      width: 100%; 
      padding: 10px; 
      margin-top: 5px; 
      font-size: 16px; 
      box-sizing: border-box;
    }
    button {
      padding: 10px; 
      font-size: 16px; 
      margin-top: 10px; 
      width: 48%;
      background: #ff5555; 
      color: white; 
      border: none; 
      border-radius: 4px;
      cursor: pointer;
    }
    .big-small-box {
      display: flex; 
      justify-content: space-around; 
      margin-top: 10px;
    }
    .big-small-item {
      border: 2px solid #ccc; 
      padding: 10px; 
      border-radius: 8px; 
      min-width: 100px;
      text-align: center; 
      background: #f9f9f9; 
      font-weight: bold; 
      font-size: 18px;
    }
    .big-text { color: purple; }
    .small-text { color: blue; }
    .hidden { display: none; }
    .win-text { color: green; font-weight: bold; }
    .lose-text { color: red; font-weight: bold; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .tab-container {
      display: flex;
      margin-bottom: 15px;
    }
    .tab {
      padding: 10px 20px;
      background: #ddd;
      cursor: pointer;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }
    .tab.active {
      background: white;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Added styles from sever30.html */
    .input-group {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    .top-predictions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .top-card {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      text-align: center;
      border-top: 3px solid #3498db;
    }
    .top-card:nth-child(1) { border-top-color: #e74c3c; }
    .top-card:nth-child(2) { border-top-color: #f39c12; }
    .top-card:nth-child(3) { border-top-color: #2ecc71; }
    .top-title {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 5px;
    }
    .server-label {
      font-size: 11px;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    .prediction {
      font-size: 18px;
      font-weight: bold;
      margin: 8px 0;
      padding: 6px;
      border-radius: 4px;
    }
    .big { background: rgba(52, 152, 219, 0.1); color: #2980b9; }
    .small { background: rgba(231, 76, 60, 0.1); color: #c0392b; }
    .equal { background: rgba(155, 89, 182, 0.1); color: #8e44ad; }
    .stats {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 8px;
    }
    .win { color: #27ae60; }
    .lose { color: #e74c3c; }
    .equal-stat { color: #9b59b6; }
    .server-container {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .server-title {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .server-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }
    .server-card {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
      transition: all 0.2s;
    }
    .server-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .server-label-grid {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 5px;
    }
    .server-prediction {
      font-size: 16px;
      font-weight: bold;
      margin: 6px 0;
      padding: 4px;
      border-radius: 4px;
    }
    .stats-grid {
      font-size: 11px;
      color: #7f8c8d;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .win-grid { color: #27ae60; }
    .lose-grid { color: #e74c3c; }
    .loading {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }
    @media (max-width: 900px) {
      .server-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width: 600px) {
      .server-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 400px) {
      .server-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<div class="box" id="loginBox">
  <div class="title">Login with Access Key</div>
  <input type="text" id="accessKeyInput" placeholder="Enter your key" />
  <button onclick="verifyKey()">Login</button>
  <div id="error" style="color:red; margin-top:10px;"></div>
</div>

<div id="appBox" class="hidden">
  <div class="tab-container">
    <div class="tab active" onclick="switchTab('serverAnalysis')">Server Analysis</div>
    <div class="tab" onclick="switchTab('digitPrediction')">Digit Prediction</div>
  </div>

  <div id="timerDisplay" style="text-align: right; margin-bottom: 10px;"></div>

  <!-- Server Analysis Tab (replaced Block Analysis) -->
  <div id="serverAnalysis" class="tab-content active">
    <div class="box">
      <h2>🎯 Server Prediction Analysis</h2>
      
      <div class="input-group">
        <label for="startBlock">Start Block Number</label>
        <input type="number" id="startBlock" value="73019765">
        
        <label for="count">Number of Blocks (minimum 3)</label>
        <input type="number" id="count" value="10" min="3">
        
        <button onclick="fetchBlocks()">Analyze Blocks</button>
      </div>

      <div id="loading" class="loading">Loading data...</div>
      
      <div id="topPredictions"></div>
      
      <div class="server-container">
        <div class="server-title">Server Predictions (1-30)</div>
        <div id="digitAnalysis" class="server-grid"></div>
      </div>
    </div>
  </div>

  <!-- Digit Prediction Tab -->
  <div id="digitPrediction" class="tab-content">
    <div class="box">
      <div class="title">BIG & SMALL</div>
      <div class="big-small-box">
        <div class="big-small-item small-text" id="smallBox">SMALL (0)</div>
        <div class="big-small-item big-text" id="bigBox">BIG (0)</div>
      </div>
    </div>

    <div class="box">
      <div class="title">AI Prediction: <span id="aiPredictAbove">-</span></div>
      <div class="title">Enter Number</div>
      <input type="text" id="inputNumber" placeholder="Enter digits" />
      <div style="display:flex; justify-content:space-between; gap:4%;">
        <button onclick="handleOK()">OK</button>
        <button onclick="handleSearch()">Search</button>
      </div>
    </div>

    <div class="box">
      <div class="title">Save Number</div>
      <div id="saveNumberDisplay">-</div>
      <button onclick="copySaved()">Copy</button>
      <button onclick="clearSaved()">Delete</button>
    </div>

    <div class="box">
      <div class="title">AI Prediction</div>
      <div id="aiPrediction">Next digit guess: <b>-</b></div>
      <label>Show last results: <input type="number" id="aiLimit" value="10" /></label>
      <div id="aiHistory" style="margin-top:10px; font-size:14px;"></div>
      <div id="aiSummary" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDdssjVzy2WvEiw_zzzrW_1b_wEV6qzeEY",
  authDomain: "money-277c2.firebaseapp.com",
  databaseURL: "https://money-277c2-default-rtdb.firebaseio.com",
  projectId: "money-277c2",
  storageBucket: "money-277c2.appspot.com",
  messagingSenderId: "928037596334",
  appId: "1:928037596334:android:8c57197c6f4369660cd13f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let saved = "";
let blockData = [];

// Tab switching function
function switchTab(tabId) {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

function verifyKey() {
  const key = document.getElementById("accessKeyInput").value.trim();
  const errorDiv = document.getElementById("error");
  errorDiv.textContent = "";
  db.ref("accessKeys/" + key + "/expires").get().then(snapshot => {
    if (!snapshot.exists()) return errorDiv.textContent = "Invalid key!";
    const expires = snapshot.val(), now = Date.now();
    if (now >= expires) return errorDiv.textContent = "Key expired!";
    localStorage.setItem("activeKey", key);
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("appBox").classList.remove("hidden");
    startCountdown(expires);
    saved = localStorage.getItem("savedNumbers") || "";
    document.getElementById("saveNumberDisplay").innerText = saved.slice(-10);
    updateAll();
  }).catch(err => {
    errorDiv.textContent = "Error verifying key.";
    console.error(err);
  });
}

function startCountdown(expires) {
  const display = document.getElementById("timerDisplay");
  function update() {
    const now = Date.now(), diff = expires - now;
    if (diff <= 0) {
      display.innerText = "Session expired";
      localStorage.removeItem("activeKey");
      location.reload();
      return;
    }
    const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
    display.innerText = `Expires in: ${m}m ${s}s`;
    setTimeout(update, 1000);
  }
  update();
}

function handleOK() {
  let input = document.getElementById("inputNumber").value.trim().replace(/\D/g, '');
  if (!input) return;
  saved += input;
  localStorage.setItem("savedNumbers", saved);
  document.getElementById("inputNumber").value = "";
  document.getElementById("saveNumberDisplay").innerText = saved.slice(-10);
  updateAll();
}

function handleSearch() {
  let input = document.getElementById("inputNumber").value.trim().replace(/\D/g, '');
  if (!input || saved.length < input.length + 1) return;
  let s = 0, b = 0;
  for (let i = 0; i < saved.length - input.length; i++) {
    if (saved.substr(i, input.length) === input) {
      const next = saved[i + input.length];
      if (!next) continue;
      if ("01234".includes(next)) s++;
      if ("56789".includes(next)) b++;
    }
  }
  document.getElementById("smallBox").innerHTML = `SMALL (<span class="small-text">${s}</span>)`;
  document.getElementById("bigBox").innerHTML = `BIG (<span class="big-text">${b}</span>)`;
  saved += input.slice(-1);
  localStorage.setItem("savedNumbers", saved);
  document.getElementById("saveNumberDisplay").innerText = saved.slice(-10);
  document.getElementById("inputNumber").value = "";
  updateAll();
}

function copySaved() {
  navigator.clipboard.writeText(saved);
  alert("Copied!");
}

function clearSaved() {
  saved = "";
  localStorage.removeItem("savedNumbers");
  document.getElementById("saveNumberDisplay").innerText = "-";
  document.getElementById("smallBox").innerHTML = `SMALL (<span class="small-text">0</span>)`;
  document.getElementById("bigBox").innerHTML = `BIG (<span class="big-text">0</span>)`;
  document.getElementById("inputNumber").value = "";
  updateAll();
}

function updateAll() {
  aiPredict();
}

function aiPredict() {
  if (saved.length < 2) return;
  const freq = {};

  for (let i = 0; i < saved.length - 1; i++) {
    let key = saved[i], next = saved[i + 1];
    if (!freq[key]) freq[key] = {};
    if (!freq[key][next]) freq[key][next] = 0;
    freq[key][next]++;
  }

  const last = saved[saved.length - 1];
  if (!freq[last]) return;

  const sorted = Object.entries(freq[last]).sort((a, b) => b[1] - a[1]);
  const top3 = sorted.slice(0, 3).map(x => x[0]);
  const topLabel = "01234".includes(top3[0]) ? "SMALL" : "BIG";
  document.getElementById("aiPredictAbove").innerText = `${top3.join(", ")} (${topLabel})`;
  document.getElementById("aiPrediction").innerHTML = `Next digit guesses: <b>${top3.join(", ")}</b> (${topLabel})`;

  const digitStats = {};
  for (const digit of top3) digitStats[digit] = { win: 0, lose: 0 };

  let top1Win = 0, top1Lose = 0;

  for (let i = 0; i < saved.length - 1; i++) {
    const current = saved[i];
    const next = saved[i + 1];
    const predTable = freq[current];
    if (!predTable) continue;

    const sortedPreds = Object.entries(predTable).sort((a, b) => b[1] - a[1]);
    const preds = sortedPreds.slice(0, 3).map(x => x[0]);

    preds.forEach(predDigit => {
      const actual = next;
      const predictedIsBig = "56789".includes(predDigit);
      const actualIsBig = "56789".includes(actual);
      const result = predictedIsBig === actualIsBig ? "win" : "lose";
      if (digitStats[predDigit]) {
        digitStats[predDigit][result]++;
      }
    });

    const topPred = preds[0];
    if (topPred) {
      const isWin = ("56789".includes(topPred) === "56789".includes(next));
      if (isWin) top1Win++; else top1Lose++;
    }
  }

  let detailHTML = `<br/><b>Top 1 Total:</b> <span class="win-text">Win ${top1Win}</span>, <span class="lose-text">Lose ${top1Lose}</span><br/><br/>`;
  detailHTML += `<b>Details:</b><br/>`;
  top3.forEach(d => {
    const stat = digitStats[d];
    detailHTML += `- ${d}: <span class="win-text">Win ${stat.win}</span>, <span class="lose-text">Lose ${stat.lose}</span><br/>`;
  });

  document.getElementById("aiSummary").innerHTML = detailHTML;

  // Show last results history
  const aiLimit = parseInt(document.getElementById("aiLimit").value || "10");
  let historyHtml = "";
  for (let i = Math.max(0, saved.length - aiLimit - 1); i < saved.length - 1; i++) {
    const current = saved[i];
    const next = saved[i + 1];
    const predTable = freq[current];
    if (!predTable) continue;
    const sortedPreds = Object.entries(predTable).sort((a, b) => b[1] - a[1]);
    const preds = sortedPreds.slice(0, 3).map(x => x[0]);
    const result = preds.includes(next) ? "✅" : "❌";
    historyHtml += `${current} → ${next} (${preds.join(", ")}) ${result}<br/>`;
  }
  document.getElementById("aiHistory").innerHTML = historyHtml;
}

// Added from sever30.html
async function fetchBlocks() {
  const startBlock = parseInt(document.getElementById("startBlock").value);
  const count = parseInt(document.getElementById("count").value);
  const interval = 20;
  const loading = document.getElementById("loading");
  const topPredictions = document.getElementById("topPredictions");
  const digitAnalysis = document.getElementById("digitAnalysis");

  loading.textContent = "Fetching block data... Please wait.";
  topPredictions.innerHTML = '';
  digitAnalysis.innerHTML = '';

  // Fetch all blocks
  const blocks = [];
  for (let i = 0; i < count; i++) {
    const blockNum = startBlock + i * interval;
    try {
      const res = await fetch("https://api.trongrid.io/wallet/getblockbynum", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ num: blockNum })
      });
      const data = await res.json();
      blocks.push({
        number: blockNum,
        hash: data.blockID || "",
        error: !data.blockID
      });
    } catch (e) {
      blocks.push({
        number: blockNum,
        hash: "",
        error: true
      });
    }
  }

  // Process each block for digit analysis (1-30)
  const analysisData = [];
  for (let i = 0; i < blocks.length; i++) {
    const block = blocks[i];
    const analysisRow = {
      blockNumber: block.number,
      predictions: Array(30).fill(null)
    };

    if (!block.error && block.hash) {
      // Extract digits from right to left
      const allDigits = [];
      for (let j = block.hash.length - 1; j >= 0; j--) {
        if (/\d/.test(block.hash[j])) {
          allDigits.push(block.hash[j]);
        }
      }

      // Analyze for digit counts 1-30
      for (let digitCount = 1; digitCount <= 30; digitCount++) {
        const digits = allDigits.slice(0, digitCount);
        const bigCount = digits.filter(d => parseInt(d) >= 5).length;
        const smallCount = digits.length - bigCount;
        const result = (bigCount > smallCount) ? "Big" : (bigCount < smallCount) ? "Small" : "Equal";
        analysisRow.predictions[digitCount-1] = result;
      }
    }
    analysisData.push(analysisRow);
  }

  // Calculate win/lose for each digit count (1-30)
  const digitStats = Array(30).fill().map((_, index) => ({
    digitCount: index + 1,
    wins: 0,
    loses: 0,
    equals: 0,
    winRate: 0
  }));
  
  for (let i = 0; i < analysisData.length - 1; i++) {
    const currentBlock = analysisData[i];
    const nextBlock = analysisData[i+1];
    
    if (nextBlock.predictions && nextBlock.predictions.length > 0) {
      // Get first digit of next block for comparison
      const firstDigitNextBlock = nextBlock.predictions[0] === "Big" ? "Big" : 
                               nextBlock.predictions[0] === "Small" ? "Small" : null;
      
      if (firstDigitNextBlock) {
        for (let digitCount = 0; digitCount < 30; digitCount++) {
          const predicted = currentBlock.predictions[digitCount];
          if (predicted === "Big" || predicted === "Small") {
            if (predicted === firstDigitNextBlock) {
              digitStats[digitCount].wins++;
            } else {
              digitStats[digitCount].loses++;
            }
          } else if (predicted === "Equal") {
            digitStats[digitCount].equals++;
          }
        }
      }
    }
  }

  // Calculate win rates and sort
  digitStats.forEach(stat => {
    const total = stat.wins + stat.loses;
    stat.winRate = total > 0 ? (stat.wins / total) * 100 : 0;
  });

  // Sort by win rate (highest first)
  const sortedStats = [...digitStats].sort((a, b) => b.winRate - a.winRate);

  // Display top 3 predictions (more compact)
  let topHTML = '<div class="top-predictions">';
  for (let i = 0; i < Math.min(3, sortedStats.length); i++) {
    const stat = sortedStats[i];
    const currentPrediction = analysisData[0].predictions[stat.digitCount-1] || "-";
    const predClass = currentPrediction.toLowerCase();
    
    topHTML += `
      <div class="top-card">
        <div class="top-title">TOP ${i+1}</div>
        <div class="server-label">Server ${stat.digitCount}</div>
        <div class="prediction ${predClass}">${currentPrediction}</div>
        <div class="stats">
          <span class="win">✅ ${stat.wins}</span>
          <span class="lose">❌ ${stat.loses}</span>
          <span class="equal-stat">⚖ ${stat.equals}</span>
        </div>
      </div>
    `;
  }
  topHTML += '</div>';
  topPredictions.innerHTML = topHTML;

  // Display server predictions (1-30) in 5-column grid
  let serverHTML = '';
  for (let digitCount = 1; digitCount <= 30; digitCount++) {
    const stat = digitStats[digitCount-1];
    const currentPrediction = analysisData[0].predictions[digitCount-1] || "-";
    const predClass = currentPrediction.toLowerCase();
    
    serverHTML += `
      <div class="server-card">
        <div class="server-label-grid">Server ${digitCount}</div>
        <div class="server-prediction ${predClass}">${currentPrediction}</div>
        <div class="stats-grid">
          <span class="win-grid">${stat.wins}✅</span>
          <span class="lose-grid">${stat.loses}❌</span>
        </div>
      </div>
    `;
  }
  digitAnalysis.innerHTML = serverHTML;

  loading.textContent = "Analysis complete!";
}

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("inputNumber");
  input.addEventListener("paste", function(e) {
    e.preventDefault();
    let paste = (e.clipboardData || window.clipboardData).getData('text');
    paste = paste.replace(/[^0-9]/g, '');
    const start = this.selectionStart;
    const end = this.selectionEnd;
    const current = this.value;
    this.value = current.slice(0, start) + paste + current.slice(end);
    this.setSelectionRange(start + paste.length, start + paste.length);
  });

  input.addEventListener("input", function() {
    this.value = this.value.replace(/[^0-9]/g, "");
  });

  // Watch for changes in aiLimit input
  document.getElementById("aiLimit").addEventListener("change", updateAll);
});
</script>
</body>
</html>